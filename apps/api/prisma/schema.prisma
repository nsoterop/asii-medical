generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public"]
}

enum ImportRunStatus {
  QUEUED
  RUNNING
  FAILED
  SUCCEEDED

  @@schema("public")
}

enum UserStatus {
  PENDING_REVIEW
  ACTIVE
  SUSPENDED

  @@schema("public")
}

enum CartStatus {
  ACTIVE
  SUBMITTED
  ABANDONED

  @@schema("public")
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  FULFILLING
  SHIPPED
  DELIVERED
  CANCELED
  REFUNDED
  PARTIALLY_REFUNDED
  FAILED

  @@schema("public")
}

enum ShipmentStatus {
  PENDING
  SHIPPED
  DELIVERED
  CANCELED

  @@schema("public")
}

model Manufacturer {
  manufacturerId Int       @id
  name           String
  products       Product[]

  @@schema("public")
}

model CategoryPath {
  categoryPathId   String    @id
  categoryPathName String
  products         Product[]

  @@schema("public")
}

model Category {
  id         String   @id @default(cuid())
  name       String
  path       String   @unique
  parentPath String?
  depth      Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([parentPath])
  @@index([depth])
  @@schema("public")
}

model Product {
  productId             Int           @id
  productName           String
  productDescription    String?
  manufacturerId        Int?
  primaryCategoryPathId String?
  manufacturer          Manufacturer? @relation(fields: [manufacturerId], references: [manufacturerId])
  primaryCategoryPath   CategoryPath? @relation(fields: [primaryCategoryPathId], references: [categoryPathId])
  skus                  Sku[]

  @@index([manufacturerId])
  @@index([primaryCategoryPathId])
  @@schema("public")
}

model Sku {
  itemId                 Int       @id
  productId              Int
  manufacturerItemCode   String?
  itemDescription        String?
  itemImageUrl           String?
  ndcItemCode            String?
  pkg                    String?
  unitPrice              Decimal?  @db.Decimal(12, 2)
  priceDescription       String?
  availabilityRaw        String?
  packingListDescription String?
  unitWeight             Float?
  unitVolume             Float?
  uomFactor              Int?
  countryOfOrigin        String?
  harmonizedTariffCode   String?
  hazMatClass            String?
  hazMatCode             String?
  pharmacyProductType    String?
  nationalDrugCode       String?
  brandId                String?
  brandName              String?
  isActive               Boolean   @default(true)
  lastSeenImportRunId    String?
  lastSeenAt             DateTime?
  updatedAt              DateTime  @default(now())
  product                Product   @relation(fields: [productId], references: [productId])

  @@index([productId])
  @@index([lastSeenImportRunId])
  @@index([isActive])
  @@schema("public")
}

model ImportRun {
  id               String           @id @default(uuid()) @db.Uuid
  status           ImportRunStatus
  originalFilename String
  storedPath       String
  lastErrorText    String?
  createdAt        DateTime         @default(now())
  startedAt        DateTime?
  finishedAt       DateTime?
  totalRows        Int              @default(0)
  inserted         Int              @default(0)
  updated          Int              @default(0)
  deactivated      Int              @default(0)
  errorCount       Int              @default(0)
  rowErrors        ImportRowError[]

  @@schema("public")
}

model ImportRowError {
  id          String    @id @default(uuid()) @db.Uuid
  importRunId String    @db.Uuid
  rowNumber   Int
  field       String?
  message     String
  createdAt   DateTime  @default(now())
  importRun   ImportRun @relation(fields: [importRunId], references: [id])

  @@schema("public")
}

model User {
  id             String     @id @default(cuid())
  email          String     @unique
  supabaseUserId String?    @unique
  status         UserStatus @default(PENDING_REVIEW)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@schema("public")
}

model Profile {
  id        String   @id @db.Uuid
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  company   String
  location  String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("profiles")
  @@schema("public")
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @map("user_id")
  status    CartStatus @default(ACTIVE)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
  items     CartItem[]

  @@index([userId])
  @@index([status])
  @@map("carts")
  @@schema("public")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String   @map("cart_id")
  productId String   @map("product_id")
  variantId String?  @map("variant_id")
  qty       Int
  unitPrice Decimal  @map("unit_price") @db.Decimal(10, 2)
  currency  String   @default("USD")
  meta      Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId, variantId])
  @@index([cartId])
  @@map("cart_items")
  @@schema("public")
}

model Order {
  id              String      @id @default(cuid())
  userId          String
  cartId          String
  squareOrderId   String      @unique
  squarePaymentId String?     @unique
  status          OrderStatus @default(PENDING_PAYMENT)
  currency        String      @default("USD")
  subtotal        Decimal     @db.Decimal(10, 2)
  total           Decimal     @db.Decimal(10, 2)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  items           OrderItem[]
  shipments       Shipment[]
  statusEvents    OrderStatusEvent[]

  @@index([userId])
  @@index([cartId])
  @@schema("public")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  productId   String
  variantId   String?
  name        String
  description String?
  qty         Int
  unitPrice   Decimal  @db.Decimal(10, 2)
  currency    String   @default("USD")
  meta        Json?
  createdAt   DateTime @default(now())

  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@schema("public")
}

model Shipment {
  id          String         @id @default(cuid())
  orderId     String
  carrier     String?
  service     String?
  trackingNo  String?
  trackingUrl String?
  shippedAt   DateTime?
  deliveredAt DateTime?
  status      ShipmentStatus @default(PENDING)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  order       Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@schema("public")
}

model OrderStatusEvent {
  id        String      @id @default(cuid())
  orderId   String
  from      OrderStatus?
  to        OrderStatus
  note      String?
  createdAt DateTime    @default(now())

  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@schema("public")
}
