generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ImportRunStatus {
  QUEUED
  RUNNING
  FAILED
  SUCCEEDED
}

enum UserStatus {
  PENDING_REVIEW
  ACTIVE
  SUSPENDED
}

enum CartStatus {
  ACTIVE
  SUBMITTED
  ABANDONED
}

model Manufacturer {
  manufacturerId Int       @id
  name           String
  products       Product[]
}

model CategoryPath {
  categoryPathId   String    @id
  categoryPathName String
  products         Product[]
}

model Category {
  id         String   @id @default(cuid())
  name       String
  path       String   @unique
  parentPath String?
  depth      Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([parentPath])
  @@index([depth])
}

model Product {
  productId             Int           @id
  productName           String
  productDescription    String?
  manufacturerId        Int?
  primaryCategoryPathId String?
  manufacturer          Manufacturer? @relation(fields: [manufacturerId], references: [manufacturerId])
  primaryCategoryPath   CategoryPath? @relation(fields: [primaryCategoryPathId], references: [categoryPathId])
  skus                  Sku[]

  @@index([manufacturerId])
  @@index([primaryCategoryPathId])
}

model Sku {
  itemId                 Int       @id
  productId              Int
  manufacturerItemCode   String?
  itemDescription        String?
  itemImageUrl           String?
  ndcItemCode            String?
  pkg                    String?
  unitPrice              Decimal?  @db.Decimal(12, 2)
  priceDescription       String?
  availabilityRaw        String?
  packingListDescription String?
  unitWeight             Float?
  unitVolume             Float?
  uomFactor              Int?
  countryOfOrigin        String?
  harmonizedTariffCode   String?
  hazMatClass            String?
  hazMatCode             String?
  pharmacyProductType    String?
  nationalDrugCode       String?
  brandId                String?
  brandName              String?
  isActive               Boolean   @default(true)
  lastSeenImportRunId    String?
  lastSeenAt             DateTime?
  updatedAt              DateTime  @default(now())
  product                Product   @relation(fields: [productId], references: [productId])

  @@index([productId])
  @@index([lastSeenImportRunId])
  @@index([isActive])
}

model ImportRun {
  id               String           @id @default(uuid()) @db.Uuid
  status           ImportRunStatus
  originalFilename String
  storedPath       String
  lastErrorText    String?
  createdAt        DateTime         @default(now())
  startedAt        DateTime?
  finishedAt       DateTime?
  totalRows        Int              @default(0)
  inserted         Int              @default(0)
  updated          Int              @default(0)
  deactivated      Int              @default(0)
  errorCount       Int              @default(0)
  rowErrors        ImportRowError[]
}

model ImportRowError {
  id          String    @id @default(uuid()) @db.Uuid
  importRunId String    @db.Uuid
  rowNumber   Int
  field       String?
  message     String
  createdAt   DateTime  @default(now())
  importRun   ImportRun @relation(fields: [importRunId], references: [id])
}

model User {
  id             String     @id @default(cuid())
  email          String     @unique
  supabaseUserId String?    @unique
  status         UserStatus @default(PENDING_REVIEW)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @map("user_id")
  status    CartStatus @default(ACTIVE)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
  items     CartItem[]

  @@index([userId])
  @@index([status])
  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String   @map("cart_id")
  productId String   @map("product_id")
  variantId String?  @map("variant_id")
  qty       Int
  unitPrice Decimal  @map("unit_price") @db.Decimal(10, 2)
  currency  String   @default("USD")
  meta      Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId, variantId])
  @@index([cartId])
  @@map("cart_items")
}
